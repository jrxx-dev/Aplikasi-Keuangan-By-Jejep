<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ’° Dashboard Keuangan Modern</title>

  <!-- Library CSS & Ikon -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.datatables.net/v/bs5/dt-2.0.8/datatables.min.css" rel="stylesheet">

  <style>
    :root {
      --primary-color: #008080;
      --secondary-color: #F0F2F5;
      --accent-color: #20c977;
      --text-dark: #34495E;
      --text-light: #7F8C8D;
      --card-bg: #FFFFFF;
      --border-color: #EAEFF5;
      --savings-color: #3498DB;
      --paylater-color: #E74C3C;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--secondary-color);
    }

    .wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Navigation */
    .sidebar {
      width: 260px;
      background: var(--card-bg);
      box-shadow: 0 0 30px rgba(0,0,0,0.05);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: left 0.3s ease;
    }
    .sidebar-header {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .sidebar-header .logo-icon {
      font-size: 2rem;
      color: var(--primary-color);
    }
    .sidebar-header h5 {
      margin: 0;
      font-weight: 600;
      color: var(--text-dark);
      white-space: nowrap;
    }
    .sidebar-menu {
      padding: 1rem;
      flex-grow: 1;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.8rem 1rem;
      border-radius: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .nav-link:hover, .nav-link.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 128, 128, 0.2);
    }
    .nav-link i {
      font-size: 1.2rem;
    }

    /* Main Content */
    .main-content {
      padding: 2.5rem;
      overflow-y: auto;
      flex-grow: 1;
    }

    .page-container {
        background-color: var(--card-bg);
        border-radius: 1.5rem;
        padding: 2.5rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .page-header {
        margin-bottom: 2.5rem;
    }
    .page-header h3 {
        font-weight: 700;
        color: var(--text-dark);
    }

    /* Desain Kartu dengan Ikon di Luar */
    .stat-card-wrapper {
        position: relative;
        padding-top: 24px;
        height: 100%;
    }
    .stat-card {
        padding: 2rem 1rem 1.25rem 1rem;
        background-color: var(--secondary-color);
        border-radius: 1rem;
        text-align: center;
        height: 100%;
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
    }
    .stat-card .icon-wrapper {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 48px;
        height: 48px;
        display: grid;
        place-items: center;
        border-radius: 50%;
        font-size: 1.2rem;
        color: white;
        border: 3px solid var(--card-bg);
    }
    .stat-card.saldo .icon-wrapper { background: linear-gradient(135deg, #5DADE2, #2E86C1); }
    .stat-card.tabungan .icon-wrapper { background: linear-gradient(135deg, var(--savings-color), #2980B9); }
    .stat-card.pemasukan .icon-wrapper { background: linear-gradient(135deg, var(--accent-color), #16A085); }
    .stat-card.paylater .icon-wrapper { background: linear-gradient(135deg, var(--paylater-color), #C0392B); }
    
    .stat-card .text-wrapper h6 {
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-light);
    }
    .stat-card .text-wrapper .stat-value {
        font-size: 1.2rem; 
        line-height: 1.3;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dashboard-card {
        background-color: var(--card-bg);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        height: 100%;
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
    }
    
    /* Animasi per kartu */
    .stat-card-wrapper.card-1 { animation-delay: 0.1s; }
    .stat-card-wrapper.card-2 { animation-delay: 0.2s; }
    .stat-card-wrapper.card-3 { animation-delay: 0.3s; }
    .stat-card-wrapper.card-4 { animation-delay: 0.4s; }
    .dashboard-card.card-5 { animation-delay: 0.5s; }
    .dashboard-card.card-6 { animation-delay: 0.6s; }


    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card-title-custom {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
    }
    
    /* "Transaksi Terakhir" menjadi Kartu */
    .transaction-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    .transaction-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background-color: var(--secondary-color);
        border-radius: 0.75rem;
    }
    .transaction-card .icon {
        width: 40px;
        height: 40px;
        display: grid;
        place-items: center;
        border-radius: 0.5rem;
        font-size: 1rem;
        color: white;
        flex-shrink: 0;
    }
    .transaction-card .info { 
        flex-grow: 1; 
        min-width: 0;
    }
    .transaction-card .info h6 { 
        margin: 0; 
        font-weight: 500; 
        color: var(--text-dark); 
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .transaction-card .info p { 
        margin: 0; 
        color: var(--text-light); 
        font-size: 0.8rem;
    }
    .transaction-card .amount { 
        font-weight: 600; 
        font-size: 0.95rem; 
        white-space: nowrap;
    }
    
    /* New Balance Cards Grid */
    .balance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1.25rem;
    }
    .balance-card {
        background-color: var(--secondary-color);
        border-radius: 0.75rem;
        padding: 1.25rem 1rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .balance-card .icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .balance-card h6 {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-light);
        margin-bottom: 0.25rem;
    }
    .balance-card .amount {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    .balance-card .detail-link {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--primary-color);
        cursor: pointer;
        text-decoration: none;
    }
    .balance-card .detail-link:hover {
        text-decoration: underline;
    }
    
    /* Transaction Page */
    .table-wrapper { padding: 0 !important; }
    .table { 
        border-collapse: separate; 
        border-spacing: 0 0.75rem; /* Increased spacing */
    }
    #tabelData thead th {
      background-color: transparent; 
      border: none; 
      color: var(--text-light);
      font-weight: 600; 
      text-transform: uppercase; 
      font-size: 0.8rem;
      padding: 0.75rem 1.25rem;
    }
    #tabelData tbody td {
        background-color: var(--secondary-color); 
        vertical-align: middle;
        border: none; 
        padding: 1.25rem; /* Increased padding */
    }
    #tabelData tbody tr { 
        transition: transform 0.2s; 
    }
    #tabelData tbody tr:hover { 
        transform: translateY(-3px); 
        box-shadow: 0 8px 25px rgba(0,0,0,0.07); 
    }
    #tabelData tbody td:first-child { border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
    #tabelData tbody td:last-child { border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }

    /* Modal Rincian Saldo */
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    .detail-balance-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background-color: var(--secondary-color);
        border-radius: 0.75rem;
    }
    .detail-balance-card .icon-container {
        width: 45px;
        height: 45px;
        flex-shrink: 0;
        display: grid;
        place-items: center;
        border-radius: 0.75rem;
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
    }
    .detail-balance-card .icon-container.bank-icon { background: #3498DB; }
    .detail-balance-card .icon-container.ewallet-icon { background: #9B59B6; }
    .detail-balance-card .info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-grow: 1;
        min-width: 0;
    }
    .detail-balance-card .info .name { font-weight: 500; color: var(--text-dark); }
    .detail-balance-card .info .amount { font-weight: 600; color: var(--text-dark); }

    /* Paylater Page */
    .paylater-account-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    .paylater-card {
        background-color: var(--secondary-color);
        border-radius: 1rem;
        padding: 1.5rem;
    }
    .paylater-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    .paylater-card-header h5 {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .paylater-card-header .actions .btn {
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
    }
    .paylater-card .progress {
        height: 10px;
        margin: 1rem 0;
    }
    .paylater-card .details {
        font-size: 0.9rem;
    }
    .paylater-card .details .value {
        font-weight: 600;
    }
    
    /* Loader */
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 1056; /* Higher than modal */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .metode-group {
        margin-bottom: 1rem;
    }
    .metode-group-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }
    .metode-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 0.75rem;
    }
    .metode-card {
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        font-weight: 500;
        font-size: 0.85rem;
    }
    .metode-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    .metode-card.selected {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 128, 128, 0.2);
    }

    /* Responsive */
    @media (max-width: 991.98px) {
        .wrapper {
            display: block; /* Fallback to block layout */
        }
        .sidebar { 
            position: fixed;
            width: 260px;
            left: -280px; 
            height: 100vh;
        }
        .sidebar.active {
            left: 0;
        }
        .main-content { 
            padding: 1rem; 
            margin-left: 0; 
        }
        .page-container { padding: 1rem; }
        .page-header h3 { font-size: 1.5rem; }
        .hamburger-menu {
            display: block;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--card-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
        }
    }

    @media (min-width: 992px) {
        .hamburger-menu { display: none; }
    }
  </style>
</head>

<body>
  <div id="loader" class="d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-chart-pie logo-icon"></i>
            <h5>Finance Tracker</h5>
        </div>
        <ul class="nav flex-column sidebar-menu">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-page="dashboardPage">
                    <i class="fa-solid fa-border-all"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="transaksiPage">
                    <i class="fa-solid fa-receipt"></i>
                    <span>Transaksi</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="paylaterPage">
                    <i class="fa-solid fa-calendar-day"></i>
                    <span>Paylater</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <button class="btn hamburger-menu d-lg-none" type="button" id="hamburgerMenu">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <div class="page-container">
                <div class="page-header">
                    <h3>Dashboard Ringkasan</h3>
                    <p class="text-muted">Selamat datang! Berikut adalah ringkasan keuangan Anda.</p>
                </div>
                <div class="row g-5">
                    <!-- Stat Cards -->
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card-wrapper card-1">
                            <div class="stat-card saldo">
                                <div class="icon-wrapper"><i class="fa-solid fa-wallet"></i></div>
                                <div class="text-wrapper">
                                    <h6>Saldo Operasional</h6>
                                    <p class="stat-value" id="dashboardSaldo">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card-wrapper card-2">
                            <div class="stat-card tabungan">
                                <div class="icon-wrapper"><i class="fa-solid fa-piggy-bank"></i></div>
                                <div class="text-wrapper">
                                    <h6>Total Tabungan</h6>
                                    <p class="stat-value text-info" id="dashboardTabungan">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card-wrapper card-3">
                            <div class="stat-card pemasukan">
                                <div class="icon-wrapper"><i class="fa-solid fa-arrow-trend-up"></i></div>
                                <div class="text-wrapper">
                                    <h6>Pemasukan Bulan Ini</h6>
                                    <p class="stat-value text-success" id="dashboardPemasukan">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6">
                        <div class="stat-card-wrapper card-4">
                            <div class="stat-card paylater">
                                <div class="icon-wrapper"><i class="fa-solid fa-credit-card"></i></div>
                                <div class="text-wrapper">
                                    <h6>Utang (Paylater)</h6>
                                    <p class="stat-value text-danger" id="dashboardPaylater">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="col-lg-6">
                        <div class="dashboard-card card-5">
                            <h6 class="card-title-custom">Transaksi Terakhir</h6>
                            <div id="recentTransactions" class="transaction-grid">
                                <!-- Diisi oleh JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Balance by Method -->
                    <div class="col-lg-6">
                        <div class="dashboard-card card-6">
                            <h6 class="card-title-custom">Ringkasan Saldo Operasional</h6>
                            <div id="balanceByMethod" class="balance-grid">
                                <!-- Diisi oleh JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaksi Page -->
        <div id="transaksiPage" class="page d-none">
             <div class="page-container">
                <div class="page-header">
                  <div class="row g-3 justify-content-between align-items-center">
                    <div class="col-md">
                      <h3>Riwayat Transaksi</h3>
                      <p class="text-muted mb-0">Kelola semua catatan pemasukan dan pengeluaran Anda.</p>
                    </div>
                    <div class="col-md-auto">
                      <button class="btn btn-primary w-100" id="btnTambah"><i class="bi bi-plus-circle-fill me-1"></i> Tambah Transaksi</button>
                    </div>
                  </div>
                </div>
                <div class="table-wrapper">
                    <table id="tabelData" class="table w-100"></table>
                </div>
            </div>
        </div>
        
        <!-- Paylater Page -->
        <div id="paylaterPage" class="page d-none">
             <div class="page-container">
                <div class="page-header">
                  <div class="row g-3 justify-content-between align-items-center">
                    <div class="col-md">
                      <h3>Manajemen Paylater</h3>
                      <p class="text-muted mb-0">Lacak semua tagihan dan limit Paylater Anda.</p>
                    </div>
                    <div class="col-md-auto">
                      <button class="btn btn-primary w-100" id="btnTambahPaylater"><i class="bi bi-plus-circle-fill me-1"></i> Tambah Akun</button>
                    </div>
                  </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card-wrapper card-1">
                            <div class="stat-card paylater">
                                <div class="icon-wrapper"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                                <div class="text-wrapper">
                                    <h6>Utang Saat Ini</h6>
                                    <p class="stat-value text-danger" id="paylaterUtangSaatIni">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card-wrapper card-2">
                             <div class="stat-card tabungan">
                                <div class="icon-wrapper"><i class="fa-solid fa-wallet"></i></div>
                                <div class="text-wrapper">
                                    <h6>Saldo Beku PayLater</h6>
                                    <p class="stat-value text-primary" id="paylaterSaldoBeku">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card-wrapper card-3">
                             <div class="stat-card pemasukan">
                                <div class="icon-wrapper"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                                <div class="text-wrapper">
                                    <h6>Limit Tersedia</h6>
                                    <p class="stat-value text-success" id="paylaterLimitTersedia">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="paylaterAccountList" class="paylater-account-grid">
                    <!-- Daftar Akun Paylater dirender oleh JS -->
                </div>
            </div>
        </div>
    </main>
  </div>
  
    <!-- Modal Form Tambah/Edit Transaksi -->
  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: var(--primary-color);">
          <h5 class="modal-title text-white" id="formModalTitle"><i class="bi bi-journal-plus me-2"></i>Tambah Transaksi Baru</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="transaksiForm">
            <input type="hidden" id="idTransaksi">
            <div class="mb-3">
              <label for="tanggal" class="form-label">Tanggal</label>
              <input type="date" id="tanggal" class="form-control" required>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="jenis" class="form-label">Jenis</label>
                    <select id="jenis" class="form-select" required>
                        <option value="" disabled selected>Pilih Jenis</option>
                        <option value="Pemasukan">Pemasukan</option>
                        <option value="Pengeluaran">Pengeluaran</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="kategori" class="form-label">Kategori</label>
                    <select id="kategori" class="form-select" required>
                        <option value="" disabled selected>Pilih Jenis Dahulu</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="jumlah" class="form-label">Jumlah (Rp)</label>
                <input type="text" inputmode="numeric" id="jumlah" class="form-control" placeholder="cth: 50.000" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Metode Pembayaran</label>
                <input type="hidden" id="metode" required>
                
                <div class="metode-group">
                    <h6 class="metode-group-title">Cash</h6>
                    <div class="metode-cards-container">
                        <div class="metode-card" data-value="Cash">Cash</div>
                    </div>
                </div>

                <div class="metode-group">
                    <h6 class="metode-group-title">Bank</h6>
                    <div class="metode-cards-container">
                        <div class="metode-card" data-value="BANK BRI">BRI</div>
                        <div class="metode-card" data-value="BANK BNI">BNI</div>
                        <div class="metode-card" data-value="BANK BSI">BSI</div>
                        <div class="metode-card" data-value="BANK MANDIRI">Mandiri</div>
                        <div class="metode-card" data-value="SEABANK">Seabank</div>
                    </div>
                </div>

                <div class="metode-group">
                    <h6 class="metode-group-title">E-Wallet</h6>
                    <div class="metode-cards-container">
                        <div class="metode-card" data-value="DANA">DANA</div>
                        <div class="metode-card" data-value="OVO">OVO</div>
                        <div class="metode-card" data-value="ShopeePay">ShopeePay</div>
                        <div class="metode-card" data-value="OrderKouta">OrderKouta</div>
                        <div class="metode-card" data-value="Gopay">Gopay</div>
                    </div>
                </div>
                
                <div class="metode-group">
                    <h6 class="metode-group-title">Lainnya</h6>
                    <div class="metode-cards-container">
                         <div class="metode-card" data-value="Tabungan">Tabungan</div>
                    </div>
                </div>
            </div>
            <div class="mb-3">
              <label for="deskripsi" class="form-label">Deskripsi</label>
              <textarea id="deskripsi" class="form-control" rows="2" placeholder="Detail transaksi..." required></textarea>
            </div>
            <div class="mb-3">
                <label for="fileUpload" class="form-label">Upload Bukti (Opsional)</label>
                <input type="file" id="fileUpload" class="form-control" accept="image/*">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="btnSimpan"><i class="bi bi-check-circle me-1"></i> Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detail Saldo -->
  <div class="modal fade" id="detailSaldoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: var(--primary-color);">
          <h5 class="modal-title text-white" id="detailSaldoTitle">Rincian Saldo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailSaldoBody">
          <!-- Rincian akan di-render oleh JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form Tambah/Edit Akun Paylater -->
  <div class="modal fade" id="paylaterFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: var(--primary-color);">
          <h5 class="modal-title text-white" id="paylaterFormModalTitle"><i class="bi bi-credit-card-2-front-fill me-2"></i>Tambah Akun Paylater</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="paylaterForm">
            <input type="hidden" id="idPaylater">
            <div class="mb-3">
              <label for="paylaterProvider" class="form-label">Nama Penyedia</label>
              <input type="text" id="paylaterProvider" class="form-control" placeholder="cth: Shopee Paylater" required>
            </div>
            <div class="mb-3">
              <label for="paylaterLimit" class="form-label">Total Limit</label>
              <input type="text" inputmode="numeric" id="paylaterLimit" class="form-control" placeholder="cth: 1.000.000" required>
            </div>
            <div class="mb-3">
              <label for="paylaterUtangAwal" class="form-label">Utang Awal (Opsional)</label>
              <input type="text" inputmode="numeric" id="paylaterUtangAwal" class="form-control" placeholder="cth: 200.000">
            </div>
            <div class="mb-3">
              <label for="paylaterDueDate" class="form-label">Tanggal Jatuh Tempo Setiap Bulan</label>
              <input type="number" id="paylaterDueDate" class="form-control" placeholder="cth: 25" min="1" max="31" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="btnSimpanPaylater"><i class="bi bi-check-circle me-1"></i> Simpan Akun</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form Bayar Paylater -->
  <div class="modal fade" id="bayarPaylaterModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background-color: var(--primary-color);">
          <h5 class="modal-title text-white" id="bayarPaylaterModalTitle">Bayar Utang</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="bayarPaylaterId">
          <div class="mb-3">
            <p class="mb-1">Saldo Beku Tersedia: <strong id="saldoBekuTersedia" class="text-primary"></strong></p>
            <p class="mb-1">Utang Akun Ini: <strong id="utangAkunSaatIni" class="text-danger"></strong></p>
          </div>
          <div class="mb-3">
            <label for="jumlahBayarPaylater" class="form-label">Jumlah Pembayaran</label>
            <input type="text" inputmode="numeric" class="form-control" id="jumlahBayarPaylater" placeholder="Masukkan jumlah bayar">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="btnSimpanPembayaran">Simpan Pembayaran</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Library JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/v/bs5/dt-2.0.8/datatables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/locale/id.js"></script>

  <script>
    $(document).ready(function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHM-vfVmLsRT1OgxxWuek-sA4iDJnmh_H79bFaWf41bSdEMXX-78kkz2JpTK5jDh_TMg/exec";

        moment.locale('id'); 
        
        let allTransactions = [];
        let allPaylaterAccounts = [];

        const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        
        const loader = $('#loader');
        const showLoader = () => loader.removeClass('d-none');
        const hideLoader = () => loader.addClass('d-none');
        
        const formatNumberInput = (value) => {
            if (!value) return '';
            const numberString = value.toString().replace(/[^0-9]/g, '');
            if (numberString === '') return '';
            return parseInt(numberString, 10).toLocaleString('id-ID');
        };

        // --- PERBAIKAN DI SINI --- Fungsi unformat sekarang lebih kuat
        const unformatNumberInput = (value) => {
            if (!value) return 0;
            // Menghapus semua karakter non-digit
            return parseInt(value.toString().replace(/[^0-9]/g, ''), 10) || 0;
        };
        
        $('#jumlah, #paylaterLimit, #paylaterUtangAwal, #jumlahBayarPaylater').on('input', function(e) {
            const value = e.target.value;
            const formattedValue = formatNumberInput(value);
            if (value !== formattedValue) {
                e.target.value = formattedValue;
            }
        });
        
        $(document).on('click', '.metode-card', function() {
            $('.metode-card').removeClass('selected');
            $(this).addClass('selected');
            $('#metode').val($(this).data('value')).trigger('change');
        });

        const kategoriPemasukan = ['Gaji / Net.SI', 'Hasil Sendiri', 'Transferan', 'Bonus', 'Lain-lain'];
        const kategoriPengeluaran = ['Jajan', 'Belanja Online', 'Bayar Hutang (PayLater)', 'Lain-lain'];

        $('#jenis').on('change', function() {
            const jenis = $(this).val();
            const kategoriSelect = $('#kategori');
            kategoriSelect.empty();
            kategoriSelect.append('<option value="" disabled selected>Pilih Kategori</option>');

            let options = [];
            if (jenis === 'Pemasukan') {
                options = kategoriPemasukan;
            } else if (jenis === 'Pengeluaran') {
                options = kategoriPengeluaran;
            }

            options.forEach(opt => {
                kategoriSelect.append(`<option value="${opt}">${opt}</option>`);
            });
        });

        const table = new DataTable('#tabelData', {
            data: [], responsive: true, language: { url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/id.json' }, order: [[0, 'desc']],
            columns: [
                { title: 'Tanggal', data: 'tanggal', render: (data) => moment(data).format('LL') },
                { title: 'Deskripsi', data: 'deskripsi' },
                { title: 'Kategori', data: 'kategori' },
                { title: 'Jumlah', data: 'jumlah', className: 'text-end', render: (data, type, row) => `<span style="color: ${row.jenis === 'Pemasukan' ? 'var(--accent-color)' : '#E74C3C'}; font-weight: 600;">${row.jenis === 'Pemasukan' ? '+' : '-'} ${formatRupiah(data)}</span>`},
                { title: 'Metode', data: 'metode'},
                { title: 'Aksi', data: 'id', orderable: false, render: (data) => `<button class="btn btn-sm btn-outline-primary me-1" onclick="window.editData(${data})"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-outline-danger" onclick="window.deleteData(${data})"><i class="bi bi-trash3"></i></button>`}
            ],
            dom: 't<"d-flex justify-content-between align-items-center mt-3"ip>',
        });

        const formModal = new bootstrap.Modal(document.getElementById('formModal'));
        const detailSaldoModal = new bootstrap.Modal(document.getElementById('detailSaldoModal'));
        const paylaterFormModal = new bootstrap.Modal(document.getElementById('paylaterFormModal'));
        const bayarPaylaterModal = new bootstrap.Modal(document.getElementById('bayarPaylaterModal'));
        
        function renderAll() {
            renderDashboard();
            renderPaylaterPage();
            table.clear().rows.add(allTransactions).draw();
        }
        
        function renderDashboard() {
            const now = moment();
            let totalTabungan = 0, pemasukanBulanIni = 0;
            const groupedBalances = { 'Cash': 0, 'Bank': 0, 'E-Wallet': 0 };
            const specificBankBalances = {};
            const specificEwalletBalances = {};
            let totalPaylaterDebt = 0;

            allPaylaterAccounts.forEach(acc => {
                totalPaylaterDebt += (Number(acc.total_hutang) || 0) - (Number(acc.terbayarkan_hutang) || 0);
            });

            allTransactions.forEach(item => {
                if (item.kategori === 'Menabung' && item.jenis === 'Pengeluaran') totalTabungan += item.jumlah;
                
                const itemDate = moment(item.tanggal);
                if (item.jenis === 'Pemasukan' && item.kategori !== 'Bayar Hutang (PayLater)' && item.metode !== 'Tabungan' && itemDate.isSame(now, 'month')) {
                    pemasukanBulanIni += item.jumlah;
                }
                
                if (item.metode !== 'Tabungan') {
                     const amount = item.jenis === 'Pemasukan' ? item.jumlah : -item.jumlah;
                    const lowerMetode = item.metode.toLowerCase();

                    if (lowerMetode.includes('cash')) {
                        groupedBalances['Cash'] += amount;
                    } else if (lowerMetode.startsWith('bank') || ['SEABANK'].includes(item.metode.toUpperCase())) {
                        groupedBalances['Bank'] += amount;
                        if (!specificBankBalances[item.metode]) specificBankBalances[item.metode] = 0;
                        specificBankBalances[item.metode] += amount;
                    } else {
                        groupedBalances['E-Wallet'] += amount;
                        if (!specificEwalletBalances[item.metode]) specificEwalletBalances[item.metode] = 0;
                        specificEwalletBalances[item.metode] += amount;
                    }
                }
            });
            
            const totalOperasional = groupedBalances.Cash + groupedBalances.Bank + groupedBalances['E-Wallet'];
            $('#dashboardSaldo').text(formatRupiah(totalOperasional));
            $('#dashboardTabungan').text(formatRupiah(totalTabungan));
            $('#dashboardPemasukan').text(formatRupiah(pemasukanBulanIni));
            $('#dashboardPaylater').text(formatRupiah(totalPaylaterDebt < 0 ? 0 : totalPaylaterDebt));
            
            const recentHtml = [...allTransactions].sort((a,b) => moment(b.tanggal).unix() - moment(a.tanggal).unix()).slice(0, 4).map(item => {
                const isIncome = item.jenis === 'Pemasukan';
                return `<div class="transaction-card"><div class="icon" style="background-color: ${isIncome ? 'var(--accent-color)' : '#E74C3C'};"><i class="fa-solid ${isIncome ? 'fa-arrow-down' : 'fa-arrow-up'}"></i></div><div class="info"><h6>${item.kategori}</h6><p>${item.deskripsi} | ${moment(item.tanggal).format('DD MMM')}</p></div><span class="amount ${isIncome ? 'text-success' : 'text-danger'}">${isIncome ? '+' : '-'} ${formatRupiah(item.jumlah)}</span></div>`;
            }).join('');
            $('#recentTransactions').html(recentHtml || '<p class="text-muted text-center mt-3">Belum ada transaksi.</p>');
            
            const balanceData = [
                { name: 'Cash', value: groupedBalances['Cash'], icon: 'fas fa-money-bill-wave', color: '#2ECC71', detailType: 'none' },
                { name: 'Bank', value: groupedBalances['Bank'], icon: 'fas fa-university', color: '#3498DB', detailType: 'bank' },
                { name: 'E-Wallet', value: groupedBalances['E-Wallet'], icon: 'fas fa-wallet', color: '#9B59B6', detailType: 'ewallet' }
            ];

            const balanceHtml = balanceData.map(metode => {
                const detailLink = (metode.detailType !== 'none' && ((metode.detailType === 'bank' && Object.keys(specificBankBalances).length > 0) || (metode.detailType === 'ewallet' && Object.keys(specificEwalletBalances).length > 0)))
                    ? `<a href="#" class="detail-link" data-type="${metode.detailType}">Lihat Detail</a>` : '';
                return `<div class="balance-card"><div><div class="icon" style="color: ${metode.color};"><i class="${metode.icon}"></i></div><div><h6>${metode.name}</h6><span class="amount">${formatRupiah(metode.value)}</span></div></div>${detailLink}</div>`;
            }).join('');
            $('#balanceByMethod').html(balanceHtml || '<p class="text-muted text-center mt-3">Belum ada saldo operasional.</p>');
        
            $('.detail-link').off('click').on('click', function(e){
                e.preventDefault();
                const type = $(this).data('type');
                let title = '', detailBody = '';
                let source = type === 'bank' ? specificBankBalances : specificEwalletBalances;

                title = `Rincian Saldo ${type === 'bank' ? 'Bank' : 'E-Wallet'}`;
                detailBody = Object.keys(source).map(key => {
                    const initial = type === 'bank' ? key.replace('BANK ','').substring(0,3) : key.substring(0,1);
                    return `<div class="detail-balance-card"><div class="icon-container ${type}-icon">${initial}</div><div class="info"><span class="name">${key}</span><span class="amount">${formatRupiah(source[key])}</span></div></div>`;
                }).join('');
                
                $('#detailSaldoTitle').text(title);
                $('#detailSaldoBody').html(`<div class="detail-grid">${detailBody}</div>`);
                detailSaldoModal.show();
            });
        }

        function renderPaylaterPage() {
            let totalUtangSaatIni = 0;
            let totalLimitSemua = 0;
            
            const pembayaranPaylater = allTransactions
                .filter(t => t.jenis === 'Pengeluaran' && t.kategori === 'Bayar Hutang (PayLater)')
                .reduce((sum, t) => sum + (Number(t.jumlah) || 0), 0);

            let totalTerbayarDariSheet = 0;
            allPaylaterAccounts.forEach(acc => {
                const totalHutangAkun = Number(acc.total_hutang) || 0;
                const terbayarAkun = Number(acc.terbayarkan_hutang) || 0;
                
                totalUtangSaatIni += (totalHutangAkun - terbayarAkun);
                totalLimitSemua += (Number(acc.limit) || 0);
                totalTerbayarDariSheet += terbayarAkun;
            });
            
            const saldoBeku = pembayaranPaylater - totalTerbayarDariSheet;
            const limitTersedia = totalLimitSemua - totalUtangSaatIni;

            $('#paylaterUtangSaatIni').text(formatRupiah(totalUtangSaatIni < 0 ? 0 : totalUtangSaatIni));
            $('#paylaterSaldoBeku').text(formatRupiah(saldoBeku < 0 ? 0 : saldoBeku));
            $('#paylaterLimitTersedia').text(formatRupiah(limitTersedia < 0 ? 0 : limitTersedia));

            const paylaterHtml = allPaylaterAccounts.map(acc => {
                const totalHutangAkun = Number(acc.total_hutang) || 0;
                const terbayarAkun = Number(acc.terbayarkan_hutang) || 0;
                const limitAkun = Number(acc.limit) || 0;
                
                const utangSaatIniAkun = totalHutangAkun - terbayarAkun;
                const limitTersediaAkun = limitAkun - utangSaatIniAkun;
                const usedPercentage = limitAkun > 0 ? (utangSaatIniAkun / limitAkun) * 100 : 0;
                
                return `
                <div class="paylater-card">
                    <div class="paylater-card-header">
                        <div>
                            <h5>${acc.provider}</h5>
                            <small class="text-muted">Jatuh tempo setiap tgl ${acc.dueDate}</small>
                        </div>
                        <div class="actions dropdown">
                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item edit-paylater" href="#" data-id="${acc.id}">Edit</a></li>
                                <li><a class="dropdown-item delete-paylater" href="#" data-id="${acc.id}">Hapus</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="progress"><div class="progress-bar bg-danger" style="width: ${usedPercentage}%"></div></div>
                    <div class="details">
                        <div class="d-flex justify-content-between"><span>Utang Saat Ini</span> <span class="value text-danger">${formatRupiah(utangSaatIniAkun < 0 ? 0 : utangSaatIniAkun)}</span></div>
                        <div class="d-flex justify-content-between"><span>Total Terbayar</span> <span class="value text-success">${formatRupiah(terbayarAkun)}</span></div>
                        <div class="d-flex justify-content-between"><span>Limit Tersedia</span> <span class="value">${formatRupiah(limitTersediaAkun < 0 ? 0 : limitTersediaAkun)}</span></div>
                    </div>
                    <button class="btn btn-primary btn-sm mt-3 w-100 bayar-utang-btn" data-id="${acc.id}" ${saldoBeku <= 0 || utangSaatIniAkun <= 0 ? 'disabled' : ''}>
                        <i class="fa-solid fa-money-bill-wave me-1"></i> Bayar
                    </button>
                </div>`;
            }).join('');
            $('#paylaterAccountList').html(paylaterHtml || '<p class="text-center text-muted">Belum ada akun Paylater.</p>');
        }
        
        function refreshUI() {
            $('.stat-card, .dashboard-card').css('opacity', '0');
            setTimeout(() => {
                renderAll();
            }, 50);
        }

        $('#hamburgerMenu').on('click', function(e){
            e.preventDefault();
            $('.sidebar').toggleClass('active');
        })

        $('.sidebar .nav-link').on('click', function(e) {
            e.preventDefault();
            const targetPage = $(this).data('page');
            $('.page').addClass('d-none');
            $('#' + targetPage).removeClass('d-none');
            $('.sidebar .nav-link').removeClass('active');
            $(this).addClass('active');

            if (window.innerWidth < 992) {
                $('.sidebar').removeClass('active');
            }

            refreshUI();
        });
        
        function loadDataFromSheet(){
            showLoader();
            fetch(SCRIPT_URL + '?action=getData')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return res.json();
                })
                .then(data => {
                    // Untuk debugging, hapus tanda // di baris bawah untuk melihat data mentah di Console (F12)
                    // console.log("Data diterima dari server:", data);
                    if (data.status === 'error') {
                        throw new Error(data.message);
                    }
                    allTransactions = data.transactions.map(t => ({...t, jumlah: Number(t.jumlah), id: t.id}));
                    allPaylaterAccounts = data.paylaterAccounts.map(p => ({...p, id: p.id, limit: Number(p.limit), dueDate: Number(p.dueDate), total_hutang: Number(p.total_hutang), terbayarkan_hutang: Number(p.terbayarkan_hutang) }));
                    refreshUI();
                    hideLoader();
                }).catch(err => {
                    hideLoader();
                    Swal.fire('Gagal Memuat Data', 'Pastikan URL API di dalam kode sudah benar dan Google Sheet Anda memiliki izin akses "Anyone". Perbarui juga Code.gs Anda. Error: ' + err.message, 'error');
                });
        }

        function saveDataToSheet(payload) {
            showLoader();
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json()) 
            .then(data => {
                if(data.status === 'success'){
                    Swal.fire('Berhasil!', data.message || 'Perubahan Anda berhasil disimpan.', 'success');
                    loadDataFromSheet();
                } else {
                    throw new Error(data.message || 'Terjadi kesalahan di server.');
                }
            })
            .catch(err => {
                hideLoader();
                Swal.fire('Gagal Menyimpan', `Terjadi kesalahan. Coba lagi nanti. Error: ${err.message}`, 'error');
            });
        }

        $('#btnTambah').on('click', () => formModal.show());
        $('#btnSimpan').on('click', function() {
            const id = $('#idTransaksi').val();
            const newEntry = {
                id: id || new Date().getTime(),
                tanggal: $('#tanggal').val(), jenis: $('#jenis').val(), kategori: $('#kategori').val(),
                jumlah: unformatNumberInput($('#jumlah').val()),
                metode: $('#metode').val(), deskripsi: $('#deskripsi').val()
            };

            if (!newEntry.tanggal || !newEntry.jenis || !newEntry.kategori || isNaN(newEntry.jumlah) || newEntry.jumlah <= 0 || !newEntry.metode || !newEntry.deskripsi) {
                Swal.fire('Gagal!', 'Semua kolom wajib diisi dan jumlah harus lebih dari 0.', 'error'); return;
            }

            const payload = {
                sheetName: "transactions",
                action: id ? "update" : "add",
                id: newEntry.id,
                values: [newEntry.id, newEntry.tanggal, newEntry.jenis, newEntry.kategori, newEntry.jumlah, newEntry.metode, newEntry.deskripsi]
            };
            
            saveDataToSheet(payload);
            formModal.hide();
        });

        window.editData = (id) => {
            const data = allTransactions.find(item => item.id == id);
            if (data) {
                $('#formModalTitle').html('<i class="bi bi-pencil-square me-2"></i>Edit Transaksi');
                $('#idTransaksi').val(data.id);
                $('#tanggal').val(data.tanggal);
                
                $('#jenis').val(data.jenis).trigger('change');
                setTimeout(() => { $('#kategori').val(data.kategori); }, 100);
                
                $('#jumlah').val(formatNumberInput(data.jumlah));
                $('#metode').val(data.metode);
                $('#deskripsi').val(data.deskripsi);
                
                $('.metode-card').removeClass('selected');
                $(`.metode-card[data-value="${data.metode}"]`).addClass('selected');
                
                formModal.show();
            }
        };

        window.deleteData = (id) => {
             Swal.fire({
                title: 'Anda yakin?', text: "Data tidak dapat dikembalikan!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, hapus!', cancelButtonText: 'Batal'
             }).then((result) => {
                if (result.isConfirmed) {
                    const payload = { sheetName: "transactions", action: "delete", id: id };
                    saveDataToSheet(payload);
                }
             });
        };

        $('#formModal').on('hidden.bs.modal', function() {
            $('#formModalTitle').html('<i class="bi bi-journal-plus me-2"></i>Tambah Transaksi Baru');
            $('#transaksiForm')[0].reset();
            $('#idTransaksi').val('');
            $('.metode-card').removeClass('selected');
            $('#kategori').empty().append('<option value="" disabled selected>Pilih Jenis Dahulu</option>');
        });
        
        $('#btnTambahPaylater').on('click', () => paylaterFormModal.show());
        $('#btnSimpanPaylater').on('click', function() {
            const id = $('#idPaylater').val();
            const newAccount = {
                id: id || new Date().getTime(),
                provider: $('#paylaterProvider').val(),
                limit: unformatNumberInput($('#paylaterLimit').val()),
                dueDate: parseInt($('#paylaterDueDate').val()),
                total_hutang: unformatNumberInput($('#paylaterUtangAwal').val()) || 0,
                terbayarkan_hutang: 0
            };
            if (!newAccount.provider || isNaN(newAccount.limit) || !newAccount.dueDate) {
                Swal.fire('Gagal!', 'Nama, Limit, dan Tanggal Jatuh Tempo wajib diisi.', 'error'); return;
            }
            const payload = {
                sheetName: "paylater_accounts",
                action: id ? "update" : "add",
                id: newAccount.id,
                values: [newAccount.id, newAccount.provider, newAccount.limit, newAccount.dueDate, newAccount.total_hutang, newAccount.terbayarkan_hutang]
            };
            saveDataToSheet(payload);
            paylaterFormModal.hide();
        });
        
        $(document).on('click', '.edit-paylater', function(e){
            e.preventDefault();
            const id = $(this).data('id');
            const data = allPaylaterAccounts.find(item => item.id == id);
            if(data) {
                $('#paylaterFormModalTitle').html('<i class="bi bi-credit-card-2-front-fill me-2"></i>Edit Akun Paylater');
                $('#idPaylater').val(data.id);
                $('#paylaterProvider').val(data.provider);
                $('#paylaterLimit').val(formatNumberInput(data.limit));
                $('#paylaterUtangAwal').val(formatNumberInput(data.total_hutang));
                $('#paylaterDueDate').val(data.dueDate);
                $('#paylaterUtangAwal').prop('disabled', true);
                paylaterFormModal.show();
            }
        });

        $('#paylaterFormModal').on('hidden.bs.modal', function() {
            $('#paylaterFormModalTitle').html('<i class="bi bi-credit-card-2-front-fill me-2"></i>Tambah Akun Paylater');
            $('#paylaterForm')[0].reset();
            $('#idPaylater').val('');
            $('#paylaterUtangAwal').prop('disabled', false);
        });
        
        $(document).on('click', '.delete-paylater', function(e){
            e.preventDefault();
            const id = $(this).data('id');
            Swal.fire({ title: 'Anda yakin?', text: "Akun akan dihapus permanen!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, hapus!'})
            .then((result) => {
                if (result.isConfirmed) {
                    const payload = { sheetName: "paylater_accounts", action: "delete", id: id };
                    saveDataToSheet(payload);
                }
             });
        });

        $(document).on('click', '.bayar-utang-btn', function() {
            const id = $(this).data('id');
            const account = allPaylaterAccounts.find(acc => acc.id == id);
            
            const pembayaranPaylater = allTransactions
                .filter(t => t.jenis === 'Pengeluaran' && t.kategori === 'Bayar Hutang (PayLater)')
                .reduce((sum, t) => sum + (Number(t.jumlah) || 0), 0);
            
            let totalTerbayarDariSheet = 0;
            allPaylaterAccounts.forEach(acc => {
                totalTerbayarDariSheet += (Number(acc.terbayarkan_hutang) || 0);
            });
            
            const saldoBeku = pembayaranPaylater - totalTerbayarDariSheet;
            const utangSaatIniAkun = (Number(account.total_hutang) || 0) - (Number(account.terbayarkan_hutang) || 0);

            $('#bayarPaylaterId').val(id);
            $('#bayarPaylaterModalTitle').text(`Bayar Utang ${account.provider}`);
            $('#saldoBekuTersedia').text(formatRupiah(saldoBeku));
            $('#utangAkunSaatIni').text(formatRupiah(utangSaatIniAkun));
            $('#jumlahBayarPaylater').val('');
            bayarPaylaterModal.show();
        });

        $('#btnSimpanPembayaran').on('click', function() {
            const id = $('#bayarPaylaterId').val();
            const jumlahBayar = unformatNumberInput($('#jumlahBayarPaylater').val());
            const saldoBeku = unformatNumberInput($('#saldoBekuTersedia').text());
            const utangAkun = unformatNumberInput($('#utangAkunSaatIni').text());

            if (jumlahBayar <= 0) {
                Swal.fire('Gagal', 'Jumlah pembayaran harus lebih dari nol.', 'error');
                return;
            }
            if (jumlahBayar > saldoBeku) {
                Swal.fire('Gagal', `Jumlah bayar tidak boleh melebihi Saldo Beku yang tersedia (${formatRupiah(saldoBeku)}).`, 'error');
                return;
            }
            if (jumlahBayar > utangAkun) {
                Swal.fire('Gagal', `Jumlah bayar tidak boleh melebihi utang akun ini (${formatRupiah(utangAkun)}).`, 'error');
                return;
            }

            const payload = {
                sheetName: "paylater_accounts",
                action: "payDebt",
                id: id,
                amount: jumlahBayar
            };
            saveDataToSheet(payload);
            bayarPaylaterModal.hide();
        });

        $(document).on('click', '.add-to-calendar', function(e){
            e.preventDefault();
            const id = $(this).data('id');
            const account = allPaylaterAccounts.find(acc => acc.id == id);
            if (account) {
                const dueDate = moment().date(account.dueDate);
                if(moment().date() > account.dueDate) {
                    dueDate.add(1, 'month');
                }
                const startDate = dueDate.format('YYYYMMDD');
                const endDate = dueDate.add(1, 'day').format('YYYYMMDD');
                const title = encodeURIComponent(`Jatuh Tempo Pembayaran ${account.provider}`);
                const details = encodeURIComponent(`Jangan lupa untuk membayar tagihan ${account.provider} Anda yang jatuh tempo hari ini.`);
                
                const calendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${details}`;
                window.open(calendarUrl, '_blank');
            }
        });
        
        loadDataFromSheet();
    });
  </script>
</body>
</html>

